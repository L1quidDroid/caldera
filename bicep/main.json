{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "18308474902418289890"
    }
  },
  "parameters": {
    "environment": {
      "type": "string",
      "defaultValue": "dev",
      "allowedValues": [
        "dev",
        "stage",
        "prod-lab"
      ],
      "metadata": {
        "description": "Environment name (dev, stage, prod-lab)"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region for deployment"
      }
    },
    "deploymentId": {
      "type": "string",
      "defaultValue": "caldera-dev",
      "metadata": {
        "description": "Unique deployment identifier (stable for student policy)"
      }
    },
    "ownerTag": {
      "type": "string",
      "defaultValue": "tonyto",
      "metadata": {
        "description": "Owner tag for resource management"
      }
    },
    "costCenter": {
      "type": "string",
      "defaultValue": "cybersec-purple-team",
      "metadata": {
        "description": "Cost center for billing allocation"
      }
    },
    "attackTactic": {
      "type": "string",
      "defaultValue": "TA0001",
      "metadata": {
        "description": "MITRE ATT&CK tactic for this lab instance"
      }
    },
    "deployAgents": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploy agent VMs (Windows/Linux). Set false if hitting quota constraints."
      }
    },
    "osDiskType": {
      "type": "string",
      "defaultValue": "Premium_LRS",
      "allowedValues": [
        "Premium_LRS",
        "Standard_LRS",
        "StandardSSD_LRS"
      ],
      "metadata": {
        "description": "Storage type for OS disks. Use Standard_LRS for Free/Student accounts if Premium fails."
      }
    },
    "managementCidr": {
      "type": "string",
      "defaultValue": "0.0.0.0/0",
      "metadata": {
        "description": "CIDR allowed to reach management and UI ports (SSH/RDP/HTTP/Kibana/Caldera). Override with your public IP CIDR for tighter access."
      }
    },
    "adminUsername": {
      "type": "securestring",
      "metadata": {
        "description": "Admin username for all VMs"
      }
    },
    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Admin password for all VMs"
      }
    },
    "calderaElkInstallScript": {
      "type": "securestring",
      "metadata": {
        "description": "Base64-encoded content of the Caldera/ELK installation script"
      }
    },
    "sshPublicKey": {
      "type": "string",
      "metadata": {
        "description": "SSH public key for Linux VMs"
      }
    }
  },
  "variables": {
    "commonTags": {
      "environment": "[parameters('environment')]",
      "owner": "[parameters('ownerTag')]",
      "cost-center": "[parameters('costCenter')]",
      "mitre-attck-tactic": "[parameters('attackTactic')]",
      "data-sovereignty": "australia",
      "deployment-id": "[parameters('deploymentId')]",
      "workload": "purple-team-lab",
      "managed-by": "bicep-cicd"
    },
    "vmSizes": {
      "dev": {
        "calderaElk": "Standard_B2s",
        "agent": "Standard_B1s"
      },
      "stage": {
        "calderaElk": "Standard_D8s_v3",
        "agent": "Standard_D2s_v5"
      },
      "prod-lab": {
        "calderaElk": "Standard_E8s_v3",
        "agent": "Standard_D2s_v5"
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "network-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "managementCidr": {
            "value": "[parameters('managementCidr')]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "5132002091109137491"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "environment": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "managementCidr": {
              "type": "string",
              "defaultValue": "0.0.0.0/0",
              "metadata": {
                "description": "CIDR allowed for management/UI access (SSH/RDP/HTTP/Kibana/Caldera)"
              }
            }
          },
          "variables": {
            "vnetName": "[format('vnet-caldera-{0}', parameters('environment'))]",
            "calderaSubnetName": "snet-caldera-server",
            "elkSubnetName": "snet-elk-stack",
            "agentsSubnetName": "snet-agents"
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2023-05-01",
              "name": "[variables('vnetName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "10.0.0.0/16"
                  ]
                },
                "subnets": [
                  {
                    "name": "[variables('calderaSubnetName')]",
                    "properties": {
                      "addressPrefix": "10.0.1.0/24",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', format('nsg-caldera-{0}', parameters('environment')))]"
                      },
                      "privateEndpointNetworkPolicies": "Disabled"
                    }
                  },
                  {
                    "name": "[variables('elkSubnetName')]",
                    "properties": {
                      "addressPrefix": "10.0.2.0/24",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', format('nsg-elk-{0}', parameters('environment')))]"
                      }
                    }
                  },
                  {
                    "name": "[variables('agentsSubnetName')]",
                    "properties": {
                      "addressPrefix": "10.0.3.0/24",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', format('nsg-agents-{0}', parameters('environment')))]"
                      }
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', format('nsg-agents-{0}', parameters('environment')))]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', format('nsg-caldera-{0}', parameters('environment')))]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', format('nsg-elk-{0}', parameters('environment')))]"
              ]
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-05-01",
              "name": "[format('nsg-caldera-{0}', parameters('environment'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowSSH",
                    "properties": {
                      "priority": 100,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "22",
                      "sourceAddressPrefix": "[parameters('managementCidr')]",
                      "destinationAddressPrefix": "*",
                      "description": "Allow SSH for management"
                    }
                  },
                  {
                    "name": "AllowCALDERA",
                    "properties": {
                      "priority": 110,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "8888",
                      "sourceAddressPrefix": "[parameters('managementCidr')]",
                      "destinationAddressPrefix": "*",
                      "description": "Allow CALDERA web UI"
                    }
                  },
                  {
                    "name": "AllowAgentC2",
                    "properties": {
                      "priority": 120,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRanges": [
                        "7010",
                        "7011",
                        "7012"
                      ],
                      "sourceAddressPrefix": "10.0.3.0/24",
                      "destinationAddressPrefix": "*",
                      "description": "Allow agent C2 from agents subnet only"
                    }
                  },
                  {
                    "name": "AllowHTTP",
                    "properties": {
                      "priority": 130,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRanges": [
                        "80",
                        "443",
                        "8080"
                      ],
                      "sourceAddressPrefix": "[parameters('managementCidr')]",
                      "destinationAddressPrefix": "*",
                      "description": "Allow HTTP/HTTPS"
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-05-01",
              "name": "[format('nsg-elk-{0}', parameters('environment'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowSSH",
                    "properties": {
                      "priority": 100,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "22",
                      "sourceAddressPrefix": "[parameters('managementCidr')]",
                      "destinationAddressPrefix": "*",
                      "description": "Allow SSH for management"
                    }
                  },
                  {
                    "name": "AllowKibana",
                    "properties": {
                      "priority": 110,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "5601",
                      "sourceAddressPrefix": "[parameters('managementCidr')]",
                      "destinationAddressPrefix": "*",
                      "description": "Allow Kibana web UI"
                    }
                  },
                  {
                    "name": "AllowElasticsearch",
                    "properties": {
                      "priority": 120,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "9200",
                      "sourceAddressPrefix": "10.0.0.0/16",
                      "destinationAddressPrefix": "*",
                      "description": "Allow Elasticsearch from VNet only"
                    }
                  },
                  {
                    "name": "AllowBeats",
                    "properties": {
                      "priority": 130,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "5044",
                      "sourceAddressPrefix": "10.0.0.0/16",
                      "destinationAddressPrefix": "*",
                      "description": "Allow Filebeat/Metricbeat from VNet"
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-05-01",
              "name": "[format('nsg-agents-{0}', parameters('environment'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowSSH",
                    "properties": {
                      "priority": 100,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "22",
                      "sourceAddressPrefix": "[parameters('managementCidr')]",
                      "destinationAddressPrefix": "*",
                      "description": "Allow SSH for Linux agents"
                    }
                  },
                  {
                    "name": "AllowRDP",
                    "properties": {
                      "priority": 110,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "3389",
                      "sourceAddressPrefix": "[parameters('managementCidr')]",
                      "destinationAddressPrefix": "*",
                      "description": "Allow RDP for Windows agents"
                    }
                  },
                  {
                    "name": "AllowCALDERAC2Outbound",
                    "properties": {
                      "priority": 100,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRanges": [
                        "7010",
                        "7011",
                        "7012",
                        "8888"
                      ],
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "10.0.1.0/24",
                      "description": "Allow C2 to CALDERA server"
                    }
                  },
                  {
                    "name": "AllowELKBeatsOutbound",
                    "properties": {
                      "priority": 110,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "5044",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "10.0.2.0/24",
                      "description": "Allow log shipping to ELK"
                    }
                  }
                ]
              }
            }
          ],
          "outputs": {
            "vnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
            },
            "vnetName": {
              "type": "string",
              "value": "[variables('vnetName')]"
            },
            "calderaSubnetId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2023-05-01').subnets[0].id]"
            },
            "elkSubnetId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2023-05-01').subnets[1].id]"
            },
            "agentsSubnetId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('vnetName')), '2023-05-01').subnets[2].id]"
            },
            "nsgCalderaId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', format('nsg-caldera-{0}', parameters('environment')))]"
            },
            "nsgElkId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', format('nsg-elk-{0}', parameters('environment')))]"
            },
            "nsgAgentsId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', format('nsg-agents-{0}', parameters('environment')))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "logging-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          },
          "retentionDays": "[if(equals(parameters('environment'), 'prod-lab'), createObject('value', 90), createObject('value', 30))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "13920532291351765452"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "environment": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "retentionDays": {
              "type": "int",
              "defaultValue": 30,
              "metadata": {
                "description": "Log retention in days"
              }
            }
          },
          "variables": {
            "workspaceName": "[format('law-caldera-{0}-{1}', parameters('environment'), uniqueString(resourceGroup().id))]"
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[variables('workspaceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": "[parameters('retentionDays')]",
                "features": {
                  "enableLogAccessUsingOnlyResourcePermissions": true
                },
                "workspaceCapping": {
                  "dailyQuotaGb": "[if(equals(parameters('environment'), 'dev'), 1, if(equals(parameters('environment'), 'stage'), 5, 10))]"
                },
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "[format('{0}/{1}', variables('workspaceName'), 'MITREAttackDetections')]",
              "properties": {
                "category": "Purple Team",
                "displayName": "MITRE ATT&CK Detections",
                "query": "      union *\n      | where TimeGenerated > ago(24h)\n      | where Message contains \"MITRE\" or Message contains \"ATT&CK\" or Message contains \"T1\"\n      | extend Technique = extract(\"(T[0-9]{4}(\\\\\\\\.[0-9]{3})?)\", 1, Message)\n      | where isnotempty(Technique)\n      | summarize Count=count(), FirstSeen=min(TimeGenerated), LastSeen=max(TimeGenerated) by Technique, Computer, _ResourceId\n      | order by Count desc\n    ",
                "version": 2
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
              ]
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
              "apiVersion": "2020-08-01",
              "name": "[format('{0}/{1}', variables('workspaceName'), 'CalderaOperations')]",
              "properties": {
                "category": "Purple Team",
                "displayName": "CALDERA Operations Activity",
                "query": "      Syslog\n      | where ProcessName contains \"caldera\" or ProcessName contains \"python\"\n      | where SyslogMessage contains \"operation\" or SyslogMessage contains \"agent\"\n      | extend OperationId = extract(\"operation[_-]id[=:]['\\\\\\\"]?([a-f0-9-]+)\", 1, SyslogMessage)\n      | extend AgentId = extract(\"agent[_-]id[=:]['\\\\\\\"]?([a-f0-9-]+)\", 1, SyslogMessage)\n      | project TimeGenerated, Computer, Facility, SeverityLevel, OperationId, AgentId, SyslogMessage\n      | order by TimeGenerated desc\n    ",
                "version": 2
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/scheduledQueryRules",
              "apiVersion": "2023-03-15-preview",
              "name": "caldera-agent-checkin-failure",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "displayName": "CALDERA Agent Check-in Failure",
                "description": "Alert when agents fail to check in for 10 minutes",
                "severity": 2,
                "enabled": true,
                "evaluationFrequency": "PT5M",
                "scopes": [
                  "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
                ],
                "targetResourceTypes": [
                  "Microsoft.OperationalInsights/workspaces"
                ],
                "windowSize": "PT10M",
                "criteria": {
                  "allOf": [
                    {
                      "query": "            Heartbeat\n            | where Computer contains \"agent\"\n            | summarize LastHeartbeat=max(TimeGenerated) by Computer\n            | where LastHeartbeat < ago(10m)\n          ",
                      "timeAggregation": "Count",
                      "operator": "GreaterThan",
                      "threshold": 0,
                      "failingPeriods": {
                        "numberOfEvaluationPeriods": 1,
                        "minFailingPeriodsToAlert": 1
                      }
                    }
                  ]
                },
                "autoMitigate": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
              ]
            }
          ],
          "outputs": {
            "workspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
            },
            "workspaceName": {
              "type": "string",
              "value": "[variables('workspaceName')]"
            },
            "customerId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName')), '2022-10-01').customerId]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "caldera-elk-server-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "vmSize": {
            "value": "[variables('vmSizes')[parameters('environment')].calderaElk]"
          },
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "sshPublicKey": {
            "value": "[parameters('sshPublicKey')]"
          },
          "subnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.calderaSubnetId.value]"
          },
          "installScript": {
            "value": "[parameters('calderaElkInstallScript')]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logging-deployment'), '2025-04-01').outputs.workspaceId.value]"
          },
          "osDiskType": {
            "value": "[parameters('osDiskType')]"
          },
          "tags": {
            "value": "[union(variables('commonTags'), createObject('role', 'caldera-elk-server'))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "465590254250810372"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "environment": {
              "type": "string"
            },
            "vmSize": {
              "type": "string"
            },
            "adminUsername": {
              "type": "string"
            },
            "adminPassword": {
              "type": "securestring"
            },
            "sshPublicKey": {
              "type": "string"
            },
            "subnetId": {
              "type": "string"
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Optional Log Analytics Workspace resource ID for diagnostics"
              }
            },
            "osDiskType": {
              "type": "string",
              "defaultValue": "Premium_LRS",
              "allowedValues": [
                "Premium_LRS",
                "Standard_LRS",
                "StandardSSD_LRS"
              ],
              "metadata": {
                "description": "Storage account type for OS disk (use Standard_LRS for Free/Student accounts if Premium fails)"
              }
            },
            "tags": {
              "type": "object"
            },
            "installScript": {
              "type": "securestring"
            }
          },
          "variables": {
            "vmName": "[format('vm-caldera-elk-{0}', parameters('environment'))]",
            "nicName": "[format('nic-{0}', variables('vmName'))]",
            "pipName": "[format('pip-{0}', variables('vmName'))]",
            "osDiskName": "[format('{0}-osdisk', variables('vmName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2023-05-01",
              "name": "[variables('pipName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard"
              },
              "properties": {
                "publicIPAllocationMethod": "Static",
                "dnsSettings": {
                  "domainNameLabel": "[format('{0}-{1}', variables('vmName'), uniqueString(resourceGroup().id))]"
                }
              }
            },
            {
              "type": "Microsoft.Network/networkInterfaces",
              "apiVersion": "2023-05-01",
              "name": "[variables('nicName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "ipConfigurations": [
                  {
                    "name": "ipconfig1",
                    "properties": {
                      "subnet": {
                        "id": "[parameters('subnetId')]"
                      },
                      "privateIPAllocationMethod": "Dynamic",
                      "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('pipName'))]"
                      }
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('pipName'))]"
              ]
            },
            {
              "type": "Microsoft.Compute/virtualMachines",
              "apiVersion": "2023-07-01",
              "name": "[variables('vmName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "hardwareProfile": {
                  "vmSize": "[parameters('vmSize')]"
                },
                "osProfile": {
                  "computerName": "[variables('vmName')]",
                  "adminUsername": "[parameters('adminUsername')]",
                  "adminPassword": "[parameters('adminPassword')]",
                  "linuxConfiguration": {
                    "disablePasswordAuthentication": false,
                    "ssh": "[if(not(empty(parameters('sshPublicKey'))), createObject('publicKeys', createArray(createObject('path', format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername')), 'keyData', parameters('sshPublicKey')))), null())]"
                  }
                },
                "storageProfile": {
                  "imageReference": {
                    "publisher": "Canonical",
                    "offer": "0001-com-ubuntu-server-jammy",
                    "sku": "22_04-lts-gen2",
                    "version": "latest"
                  },
                  "osDisk": {
                    "name": "[variables('osDiskName')]",
                    "createOption": "FromImage",
                    "managedDisk": {
                      "storageAccountType": "[parameters('osDiskType')]"
                    },
                    "diskSizeGB": 256
                  }
                },
                "networkProfile": {
                  "networkInterfaces": [
                    {
                      "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"
              ]
            },
            {
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', variables('vmName'), 'caldera-elk-setup')]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Azure.Extensions",
                "type": "CustomScript",
                "typeHandlerVersion": "2.1",
                "autoUpgradeMinorVersion": true,
                "protectedSettings": {
                  "commandToExecute": "[format('bash -c \"echo {0} | base64 -d > /tmp/install-caldera-elk.sh && chmod +x /tmp/install-caldera-elk.sh && /tmp/install-caldera-elk.sh\"', parameters('installScript'))]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('vmName'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('logAnalyticsWorkspaceId')))]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Compute/virtualMachines/{0}', variables('vmName'))]",
              "name": "vm-caldera-elk-diagnostics",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true,
                    "retentionPolicy": {
                      "days": 0,
                      "enabled": false
                    }
                  }
                ],
                "logs": []
              },
              "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('vmName'))]"
              ]
            }
          ],
          "outputs": {
            "vmId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Compute/virtualMachines', variables('vmName'))]"
            },
            "vmName": {
              "type": "string",
              "value": "[variables('vmName')]"
            },
            "publicIpAddress": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('pipName')), '2023-05-01').ipAddress]"
            },
            "privateIpAddress": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/networkInterfaces', variables('nicName')), '2023-05-01').ipConfigurations[0].properties.privateIPAddress]"
            },
            "fqdn": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('pipName')), '2023-05-01').dnsSettings.fqdn]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'logging-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'network-deployment')]"
      ]
    },
    {
      "condition": "[parameters('deployAgents')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "windows-agent-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "vmSize": {
            "value": "[variables('vmSizes')[parameters('environment')].agent]"
          },
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "subnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.agentsSubnetId.value]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logging-deployment'), '2025-04-01').outputs.workspaceId.value]"
          },
          "tags": {
            "value": "[union(variables('commonTags'), createObject('role', 'red-team-agent', 'os', 'windows-server-2022', 'attack-surface', 'execution-target'))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "8308824082093100890"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "environment": {
              "type": "string"
            },
            "vmSize": {
              "type": "string"
            },
            "adminUsername": {
              "type": "string"
            },
            "adminPassword": {
              "type": "securestring"
            },
            "subnetId": {
              "type": "string"
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Optional Log Analytics Workspace resource ID for diagnostics"
              }
            },
            "tags": {
              "type": "object"
            }
          },
          "variables": {
            "vmName": "[format('vm-windows-agent-{0}', parameters('environment'))]",
            "nicName": "[format('nic-{0}', variables('vmName'))]",
            "pipName": "[format('pip-{0}', variables('vmName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2023-05-01",
              "name": "[variables('pipName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard"
              },
              "properties": {
                "publicIPAllocationMethod": "Static"
              }
            },
            {
              "type": "Microsoft.Network/networkInterfaces",
              "apiVersion": "2023-05-01",
              "name": "[variables('nicName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "ipConfigurations": [
                  {
                    "name": "ipconfig1",
                    "properties": {
                      "subnet": {
                        "id": "[parameters('subnetId')]"
                      },
                      "privateIPAllocationMethod": "Dynamic",
                      "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('pipName'))]"
                      }
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('pipName'))]"
              ]
            },
            {
              "type": "Microsoft.Compute/virtualMachines",
              "apiVersion": "2023-07-01",
              "name": "[variables('vmName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "hardwareProfile": {
                  "vmSize": "[parameters('vmSize')]"
                },
                "osProfile": {
                  "computerName": "[variables('vmName')]",
                  "adminUsername": "[parameters('adminUsername')]",
                  "adminPassword": "[parameters('adminPassword')]",
                  "windowsConfiguration": {
                    "provisionVMAgent": true,
                    "enableAutomaticUpdates": false
                  }
                },
                "storageProfile": {
                  "imageReference": {
                    "publisher": "MicrosoftWindowsServer",
                    "offer": "WindowsServer",
                    "sku": "2022-datacenter-azure-edition",
                    "version": "latest"
                  },
                  "osDisk": {
                    "name": "[format('{0}-osdisk', variables('vmName'))]",
                    "createOption": "FromImage",
                    "managedDisk": {
                      "storageAccountType": "Premium_LRS"
                    },
                    "diskSizeGB": 128
                  }
                },
                "networkProfile": {
                  "networkInterfaces": [
                    {
                      "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"
                    }
                  ]
                },
                "diagnosticsProfile": {
                  "bootDiagnostics": {
                    "enabled": true
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"
              ]
            },
            {
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', variables('vmName'), 'install-caldera-agent-winlogbeat')]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Compute",
                "type": "CustomScriptExtension",
                "typeHandlerVersion": "1.10",
                "autoUpgradeMinorVersion": true,
                "protectedSettings": {
                  "commandToExecute": "powershell.exe -ExecutionPolicy Bypass -Command \"$script=[System.Text.Encoding]::UTF8.GetString([Convert]::FromBase64String('${installScript}'));$path='C:\\Windows\\Temp\\install-windows-agent.ps1';Set-Content -Path $path -Value $script -Force; & $path -calderaServerIp ${calderaServerIp} -elkServerIp ${elkServerIp}\"\n"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('vmName'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('logAnalyticsWorkspaceId')))]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Compute/virtualMachines/{0}', variables('vmName'))]",
              "name": "vm-windows-agent-diagnostics",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true,
                    "retentionPolicy": {
                      "days": 0,
                      "enabled": false
                    }
                  }
                ],
                "logs": []
              },
              "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('vmName'))]"
              ]
            }
          ],
          "outputs": {
            "vmId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Compute/virtualMachines', variables('vmName'))]"
            },
            "vmName": {
              "type": "string",
              "value": "[variables('vmName')]"
            },
            "publicIpAddress": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('pipName')), '2023-05-01').ipAddress]"
            },
            "privateIpAddress": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/networkInterfaces', variables('nicName')), '2023-05-01').ipConfigurations[0].properties.privateIPAddress]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'logging-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'network-deployment')]"
      ]
    },
    {
      "condition": "[parameters('deployAgents')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "linux-agent-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "vmSize": {
            "value": "[variables('vmSizes')[parameters('environment')].agent]"
          },
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "sshPublicKey": {
            "value": "[parameters('sshPublicKey')]"
          },
          "subnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.agentsSubnetId.value]"
          },
          "calderaServerIp": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'caldera-elk-server-deployment'), '2025-04-01').outputs.privateIpAddress.value]"
          },
          "tags": {
            "value": "[union(variables('commonTags'), createObject('role', 'blue-team-agent', 'os', 'ubuntu-22.04', 'attack-surface', 'monitoring-target'))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "12478571828671454379"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "environment": {
              "type": "string"
            },
            "vmSize": {
              "type": "string"
            },
            "adminUsername": {
              "type": "string"
            },
            "adminPassword": {
              "type": "securestring"
            },
            "sshPublicKey": {
              "type": "string"
            },
            "subnetId": {
              "type": "string"
            },
            "calderaServerIp": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            }
          },
          "variables": {
            "vmName": "[format('vm-linux-agent-{0}', parameters('environment'))]",
            "nicName": "[format('nic-{0}', variables('vmName'))]",
            "pipName": "[format('pip-{0}', variables('vmName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2023-05-01",
              "name": "[variables('pipName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard"
              },
              "properties": {
                "publicIPAllocationMethod": "Static"
              }
            },
            {
              "type": "Microsoft.Network/networkInterfaces",
              "apiVersion": "2023-05-01",
              "name": "[variables('nicName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "ipConfigurations": [
                  {
                    "name": "ipconfig1",
                    "properties": {
                      "subnet": {
                        "id": "[parameters('subnetId')]"
                      },
                      "privateIPAllocationMethod": "Dynamic",
                      "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('pipName'))]"
                      }
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('pipName'))]"
              ]
            },
            {
              "type": "Microsoft.Compute/virtualMachines",
              "apiVersion": "2023-07-01",
              "name": "[variables('vmName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "hardwareProfile": {
                  "vmSize": "[parameters('vmSize')]"
                },
                "osProfile": {
                  "computerName": "[variables('vmName')]",
                  "adminUsername": "[parameters('adminUsername')]",
                  "adminPassword": "[parameters('adminPassword')]",
                  "linuxConfiguration": {
                    "disablePasswordAuthentication": false,
                    "ssh": {
                      "publicKeys": "[if(empty(parameters('sshPublicKey')), createArray(), createArray(createObject('path', format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername')), 'keyData', parameters('sshPublicKey'))))]"
                    }
                  }
                },
                "storageProfile": {
                  "imageReference": {
                    "publisher": "Canonical",
                    "offer": "0001-com-ubuntu-server-jammy",
                    "sku": "22_04-lts-gen2",
                    "version": "latest"
                  },
                  "osDisk": {
                    "name": "[format('{0}-osdisk', variables('vmName'))]",
                    "createOption": "FromImage",
                    "managedDisk": {
                      "storageAccountType": "Standard_LRS"
                    },
                    "diskSizeGB": 64
                  }
                },
                "networkProfile": {
                  "networkInterfaces": [
                    {
                      "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"
                    }
                  ]
                },
                "diagnosticsProfile": {
                  "bootDiagnostics": {
                    "enabled": true
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"
              ]
            },
            {
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', variables('vmName'), 'install-caldera-agent')]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "Microsoft.Azure.Extensions",
                "type": "CustomScript",
                "typeHandlerVersion": "2.1",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "commandToExecute": "[format('bash -c \"curl -s http://{0}:8888/file/download -o /tmp/sandcat && chmod +x /tmp/sandcat && nohup /tmp/sandcat -server http://{1}:8888 -group blue -v > /dev/null 2>&1 &\"', parameters('calderaServerIp'), parameters('calderaServerIp'))]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('vmName'))]"
              ]
            }
          ],
          "outputs": {
            "vmId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Compute/virtualMachines', variables('vmName'))]"
            },
            "vmName": {
              "type": "string",
              "value": "[variables('vmName')]"
            },
            "publicIpAddress": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('pipName')), '2023-05-01').ipAddress]"
            },
            "privateIpAddress": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/networkInterfaces', variables('nicName')), '2023-05-01').ipConfigurations[0].properties.privateIPAddress]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'caldera-elk-server-deployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'network-deployment')]"
      ]
    }
  ],
  "outputs": {
    "resourceGroupName": {
      "type": "string",
      "value": "[resourceGroup().name]"
    },
    "calderaElkServerUrl": {
      "type": "string",
      "value": "[format('http://{0}:8888', reference(resourceId('Microsoft.Resources/deployments', 'caldera-elk-server-deployment'), '2025-04-01').outputs.publicIpAddress.value)]"
    },
    "calderaElkKibanaUrl": {
      "type": "string",
      "value": "[format('http://{0}:5601', reference(resourceId('Microsoft.Resources/deployments', 'caldera-elk-server-deployment'), '2025-04-01').outputs.publicIpAddress.value)]"
    },
    "calderaElkServerIp": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'caldera-elk-server-deployment'), '2025-04-01').outputs.publicIpAddress.value]"
    },
    "windowsAgentIp": {
      "type": "string",
      "value": "[if(parameters('deployAgents'), reference(resourceId('Microsoft.Resources/deployments', 'windows-agent-deployment'), '2025-04-01').outputs, createObject('publicIpAddress', '')).publicIpAddress]"
    },
    "linuxAgentIp": {
      "type": "string",
      "value": "[if(parameters('deployAgents'), reference(resourceId('Microsoft.Resources/deployments', 'linux-agent-deployment'), '2025-04-01').outputs, createObject('publicIpAddress', '')).publicIpAddress]"
    },
    "logAnalyticsWorkspaceId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logging-deployment'), '2025-04-01').outputs.workspaceId.value]"
    },
    "deploymentId": {
      "type": "string",
      "value": "[parameters('deploymentId')]"
    },
    "vnetId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network-deployment'), '2025-04-01').outputs.vnetId.value]"
    },
    "accessInstructions": {
      "type": "object",
      "value": {
        "caldera_elk": {
          "caldera_url": "[format('http://{0}:8888', reference(resourceId('Microsoft.Resources/deployments', 'caldera-elk-server-deployment'), '2025-04-01').outputs.publicIpAddress.value)]",
          "kibana_url": "[format('http://{0}:5601', reference(resourceId('Microsoft.Resources/deployments', 'caldera-elk-server-deployment'), '2025-04-01').outputs.publicIpAddress.value)]",
          "default_creds": "red:admin / blue:admin",
          "ssh_command": "Use your provided admin username and the server IP."
        },
        "agents": {
          "windows": {
            "rdp_command": "Use your provided admin username and the agent IP.",
            "ip": "[if(parameters('deployAgents'), reference(resourceId('Microsoft.Resources/deployments', 'windows-agent-deployment'), '2025-04-01').outputs, createObject('publicIpAddress', '')).publicIpAddress]"
          },
          "linux": {
            "ssh_command": "Use your provided admin username and the agent IP.",
            "ip": "[if(parameters('deployAgents'), reference(resourceId('Microsoft.Resources/deployments', 'linux-agent-deployment'), '2025-04-01').outputs, createObject('publicIpAddress', '')).publicIpAddress]"
          }
        }
      }
    }
  }
}